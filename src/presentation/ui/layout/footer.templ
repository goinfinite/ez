package layout

import (
	"github.com/goinfinite/ez/src/domain/entity"
	"github.com/goinfinite/ez/src/domain/valueObject"
	"github.com/goinfinite/ez/src/presentation/ui/component/form"
	componentMisc "github.com/goinfinite/ez/src/presentation/ui/component/misc"
	"github.com/goinfinite/ez/src/presentation/ui/helper"
)

templ FooterSkeleton() {
	<footer
		id="footer"
		hx-get="/fragment/footer"
		hx-trigger="load delay:500ms"
		hx-target="this"
		hx-swap="outerHTML transition:true"
		class="bg-ez-800 border-ez-400 h-8.5 fixed bottom-0 flex w-full items-center justify-end border-t-2 px-3 text-sm transition-all duration-300 ease-in-out"
	>
		<div class="flex items-center space-x-3">
			<div class="bg-ez-200 h-6 w-9 animate-pulse rounded-md"></div>
			for i := 0; i < 3; i++ {
				<div class="bg-ez-200 w-27 h-6 animate-pulse rounded-md"></div>
			}
		</div>
	</footer>
}

func scheduledTaskStatusToIcon(taskStatus valueObject.ScheduledTaskStatus) string {
	switch taskStatus.String() {
	case "pending":
		return "ph-clock text-neutral-50"
	case "running":
		return "ph-cooking-pot text-amber-500 animate-duration-[2s] animate-pulse"
	case "completed":
		return "ph-check-circle text-emerald-500"
	case "failed":
		return "ph-x-circle text-red-600"
	case "cancelled":
		return "ph-prohibit text-red-600"
	case "timeout":
		return "ph-timer text-red-600"
	default:
		return "ph-question-circle"
	}
}

templ ScheduledTasksPopover(
	scheduledTasksEntities []entity.ScheduledTask,
) {
	<div
		x-cloak
		x-show="$store.main.displayScheduledTasksPopover"
		class="bg-ez-400 w-100 max-h-100 border-1 absolute bottom-full z-10 mt-2 -translate-x-1/2 transform overflow-y-auto rounded-t-md border-b-0 border-neutral-50/5 text-sm text-neutral-50 shadow-2xl transition-all duration-300 ease-in-out"
	>
		<div class="flex items-center justify-between rounded-t-md bg-neutral-50/5 p-2.5">
			<div class="text-base font-bold">Scheduled Tasks</div>
			<div class="text-base font-bold">
				<i
					class="ph-bold ph-minus cursor-pointer"
					@click="$store.main.toggleScheduledTasksPopover()"
				></i>
			</div>
		</div>
		if len(scheduledTasksEntities) == 0 {
			<div class="text-center text-neutral-50">No scheduled tasks.</div>
		}
		<div class="flex w-full flex-col gap-1 px-2.5 py-1.5">
			for taskEntityIndex, taskEntity := range scheduledTasksEntities {
				<div
					x-data="{ isExpanded: false }"
					@click="isExpanded = !isExpanded"
					class="group flex cursor-pointer flex-row items-center justify-evenly gap-0.5 rounded-md p-1 hover:bg-neutral-50/5"
					if taskEntityIndex%2 != 0 {
						:class="{ 'bg-neutral-950/20': true }"
					}
					:class="{'bg-neutral-950/20 hover:bg-neutral-950/20': isExpanded}"
				>
					<div class="text-center align-middle" x-show="!isExpanded">
						<i class={ "text-opacity-80 text-xl ph-duotone " + scheduledTaskStatusToIcon(taskEntity.Status) }></i>
					</div>
					<div class="w-[90%] py-1.5" :class="{ 'w-full p-2.5': isExpanded }">
						{ taskEntity.Name.String() } <small class="font-bold">#{ taskEntity.Id.String() }</small>
						if taskEntity.ElapsedSecs != nil {
							<small>({ uiHelper.FormatPointer(taskEntity.ElapsedSecs) })</small>
						}
						<i
							class="ph-bold text-md float-right opacity-0 transition-all duration-300 group-hover:opacity-80"
							:class="{ 'ph-arrows-in-simple': isExpanded, 'ph-arrows-out-simple': !isExpanded }"
						></i>
						<div x-show="!isExpanded">
							if taskEntity.Output != nil {
								<p class="truncate rounded-md bg-neutral-950/20 px-1 text-[10px] text-neutral-100/90">
									{ taskEntity.Output.String() }
								</p>
							}
							if taskEntity.Error != nil {
								<p class="truncate rounded-md bg-red-500/20 px-1 text-[10px] text-neutral-100/90">
									{ taskEntity.Error.String() }
								</p>
							}
						</div>
						<div class="max-w-85 space-y-2 text-[10px]" x-show="isExpanded">
							@componentForm.TextArea(componentForm.TextAreaSettings{
								Id:         "taskCmd_" + taskEntity.Id.String(),
								Label:      "Command",
								Value:      taskEntity.Command.String(),
								Size:       componentForm.TextAreaSizeXs,
								IsCode:     true,
								IsReadOnly: true,
							})
							@componentForm.TextArea(componentForm.TextAreaSettings{
								Id:         "taskOutput_" + taskEntity.Id.String(),
								Label:      "Output",
								Value:      uiHelper.FormatPointer(taskEntity.Output),
								Size:       componentForm.TextAreaSizeXs,
								IsCode:     true,
								IsReadOnly: true,
							})
							@componentForm.TextArea(componentForm.TextAreaSettings{
								Id:         "taskError_" + taskEntity.Id.String(),
								Label:      "Error",
								Value:      uiHelper.FormatPointer(taskEntity.Error),
								Size:       componentForm.TextAreaSizeXs,
								IsCode:     true,
								IsReadOnly: true,
							})
							<div class="max-w-80">
								<p class="font-bold">Timings</p>
								<table>
									<tbody>
										<thead class="bg-ez-600">
											<th class="text-left">CreatedAt</th>
											<th class="bg-ez-500 text-left">StartedAt</th>
											<th class="text-left">FinishedAt</th>
										</thead>
										<tr>
											<td class="text-wrap break-words p-1">
												{ taskEntity.CreatedAt.ReadAsRfcDate() }
											</td>
											<td class="bg-ez-400 text-wrap break-words p-1">
												if taskEntity.StartedAt != nil {
													{ taskEntity.StartedAt.ReadAsRfcDate() }
												} else {
													-
												}
											</td>
											<td class="text-wrap break-words p-1">
												if taskEntity.FinishedAt != nil {
													{ taskEntity.FinishedAt.ReadAsRfcDate() }
												} else {
													-
												}
											</td>
										</tr>
									</tbody>
								</table>
							</div>
							<div class="space-x-2">
								if taskEntity.Status.String() == "pending" {
									<button
										hx-put="/api/v1/scheduled-task/"
										hx-vals={ "{\"taskId\": " + taskEntity.Id.String() + ", \"status\": \"cancelled\"}" }
										hx-trigger="click"
										hx-swap="none"
										@click="$dispatch('refresh:footer')"
										class="rounded-md border-none bg-red-800 bg-opacity-60 px-2 py-1 text-center text-sm font-bold lowercase leading-none hover:bg-opacity-80"
									>
										<i class="ph-bold ph-hand-palm mr-0.5 align-middle"></i>
										Cancel
									</button>
								} else {
									if taskEntity.Status.String() != "running" {
										<button
											hx-put="/api/v1/scheduled-task/"
											hx-vals={ "{\"taskId\": " + taskEntity.Id.String() + ", \"status\": \"pending\"}" }
											hx-trigger="click"
											hx-swap="none"
											@click="$dispatch('refresh:footer')"
											class="rounded-md border-none bg-amber-700 bg-opacity-60 px-2 py-1 text-center text-sm font-bold lowercase leading-none hover:bg-opacity-80"
										>
											<i class="ph-bold ph-repeat mr-0.5 align-middle"></i>
											Run Again
										</button>
									}
								}
							</div>
						</div>
					</div>
				</div>
			}
		</div>
	</div>
}

templ ResourceUsageProgressBar(usageRate uint8, usageLabel, tooltipText, icon string) {
	<div class="group relative flex items-center">
		<i class={ "ph-bold " + icon + " mr-2 align-middle text-xl" }></i>
		@componentMisc.ProgressBar(usageRate, usageLabel)
		<div class={ "absolute left-1/2 transform -translate-x-1/2 opacity-0 bottom-full mb-2 transition-all duration-300 group-hover:block group-hover:-translate-y-0.5 group-hover:opacity-100 p-1.5 bg-ez-300 text-neutral-50 text-xs rounded-md shadow-md" }>
			{ tooltipText }
		</div>
	</div>
}

templ Footer(
	o11yOverviewEntity entity.O11yOverview,
	scheduledTasksEntities []entity.ScheduledTask,
) {
	<footer
		id="footer"
		hx-get="/fragment/footer"
		hx-trigger="every 20s, refresh:footer from:window delay:200ms"
		hx-target="this"
		hx-swap="outerHTML"
		class="bg-ez-800 border-ez-400 h-8.5 z-2 fixed bottom-0 flex w-full items-center justify-end border-t-2 px-3 text-sm transition-all duration-300 ease-in-out"
	>
		<div
			class="mr-5 flex h-full items-center"
			:class="$store.main.displayScheduledTasksPopover ? 'bg-ez-300' : 'bg-ez-800'"
		>
			<i
				class="ph-bold ph-list-checks cursor-pointer px-1 text-xl"
				@click="$store.main.toggleScheduledTasksPopover()"
			></i>
			@ScheduledTasksPopover(scheduledTasksEntities)
		</div>
		<div class="flex items-center space-x-3">
			@ResourceUsageProgressBar(
				uint8(o11yOverviewEntity.HostResourceUsage.CpuPercent),
				o11yOverviewEntity.HostResourceUsage.CpuPercentStr+"%",
				"CPU",
				"ph-speedometer",
			)
			@ResourceUsageProgressBar(
				uint8(o11yOverviewEntity.HostResourceUsage.MemoryPercent),
				o11yOverviewEntity.HostResourceUsage.MemoryPercentStr+"%",
				"RAM",
				"ph-memory",
			)
			@ResourceUsageProgressBar(
				uint8(o11yOverviewEntity.HostResourceUsage.UserDataStorageInfo.UsedPercent),
				o11yOverviewEntity.HostResourceUsage.UserDataStorageInfo.UsedPercentStr+"%",
				"/var/data",
				"ph-hard-drives",
			)
		</div>
	</footer>
}
