package page

import (
	"github.com/goinfinite/ez/src/domain/dto"
	"github.com/goinfinite/ez/src/domain/entity"
	"github.com/goinfinite/ez/src/domain/valueObject"
	componentContainer "github.com/goinfinite/ez/src/presentation/ui/component/container"
	componentForm "github.com/goinfinite/ez/src/presentation/ui/component/form"
	componentMisc "github.com/goinfinite/ez/src/presentation/ui/component/misc"
	componentStructural "github.com/goinfinite/ez/src/presentation/ui/component/structural"
	"strconv"
)

type CreateContainerModalDto struct {
	AppMarketplaceCarouselItems       []templ.Component
	FrameworkMarketplaceCarouselItems []templ.Component
	StackMarketplaceCarouselItems     []templ.Component
	ContainerImageSearchableItems     []componentForm.SearchableSelectItem
	ContainerProfileSearchableItems   []componentForm.SearchableSelectItem
	AccountSelectLabelValuePairs      []componentForm.SelectLabelValuePair
	ContainerSummarySearchableItems   []componentForm.SearchableSelectItem
}

script OverviewIndexLocalState(containersCurrentPageNumber int) {
	document.addEventListener('alpine:init', () => {
		Alpine.data('containers', () => ({
			// Primary State
			container: {},
			resetPrimaryState() {
				this.container = {
					'id': '',
					'accountId': '',
					'hostname': '',
					'status': true,
					'imageAddress': 'docker.io/goinfinite/os:latest',
					'portBindings': [],
					'restartPolicy': 'unless-stopped',
					'entrypoint': '',
					'profileId': "1",
					'envs': [],
					'launchScript': '',
					'autoCreateMappings': true,
					'existingContainerId': '',
					'useImageExposedPorts': false,
				};
			},
			init() {
				this.resetPrimaryState();
			},
			async autoPortBindingsRetriever(prevImageAddress, newImageAddress) {
				if (!this.isCreateContainerModalOpen) {
					return;
				}

				const isSameImage = prevImageAddress === newImageAddress;
				const isPortBindingsEmpty = this.container.portBindings.length === 0;
				if (isSameImage && !isPortBindingsEmpty) {
					return;
				}

				const isImageAddressTooShort = newImageAddress.length < 3;
				const isImageNotAddressYet = !newImageAddress.includes('/');
				if (isImageAddressTooShort || isImageNotAddressYet) {
					this.container.portBindings = [];
					return;
				}

				const remoteApiUrl = '/api/v1/container/registry/image/tagged/?address=' + this.container.imageAddress;
				this.container.portBindings = await fetch(remoteApiUrl, {
					method: "GET",
						headers: {
						Accept: "application/json",
						"Content-Type": "application/json",
					},
				})
					.then((apiResponse) => {
						if (!apiResponse.ok) {
							throw new Error('BadHttpResponseCode: ' + apiResponse.status);
						}

						return apiResponse.json();
					})
					.then((jsonResponse) => {
						return jsonResponse.body.portBindings;
					})
					.catch((error) => {
						console.error('AutoUpdatePortBindingsError: ', error);
						return [];
					});
			},
			syncExistingContainerPortBindings(prevId, newId) {
				if (!this.isCreateContainerModalOpen) {
					return;
				}

				const isSameContainer = prevId === newId;
				const isPortBindingsEmpty = this.container.portBindings.length === 0;
				if (isSameContainer && !isPortBindingsEmpty) {
					return;
				}

				if (newId.length < 12) {
					this.container.portBindings = [];
					return;
				}

				const containerEntity = JSON.parse(
					document.getElementById('containerEntity_'+newId).textContent
				);
				portBindingsWithoutPrivatePorts = containerEntity.portBindings.map(
					originalPortBinding => {
						adjustedPortBinding = Object.assign({}, originalPortBinding);

						adjustedPortBinding.publicPort = adjustedPortBinding.containerPort;
						delete adjustedPortBinding.privatePort;

						return adjustedPortBinding;
					},
				);

				this.container.portBindings = portBindingsWithoutPrivatePorts;
			},

			// Auxiliary States
			createContainerSourceSelectedOption: 'Marketplace',
			createContainerSelectedMarketplaceType: 'App',
			createContainerSelectedMarketplaceItemId: 0,
			updateSelectedMarketplaceItem(itemId) {
				this.createContainerSelectedMarketplaceItemId = itemId;
				const marketplaceItemEntity = JSON.parse(
					document.getElementById('marketplaceItemEntity_'+itemId).textContent
				);
				this.container.imageAddress = marketplaceItemEntity.registryImageAddress;
				this.container.launchScript = '';
				if (marketplaceItemEntity.hasOwnProperty('launchScript')) {
					this.container.launchScript = marketplaceItemEntity.launchScript;
				}
			},
			containersFilters: {
				containerId: '',
				accountId: '',
				hostname: '',
				status: '',
				imageId: '',
				imageAddress: '',
				imageHash: '',
				restartPolicy: '',
				profileId: '',
			},
			containersPagination: {
				pageNumber: containersCurrentPageNumber,
				itemsPerPage: 5,
			},
			reloadContainersTable() {
				queryParams = new URLSearchParams();
				queryParams.set('containersPageNumber', this.containersPagination.pageNumber);
				queryParams.set('containersItemsPerPage', this.containersPagination.itemsPerPage);

				for (let [filterKey, filterValue] of Object.entries(this.containersFilters)) {
					filterValue = filterValue.trim();
					if (filterValue === '') {
						continue;
					}
					const filterKeyCapitalized = filterKey.charAt(0).toUpperCase() + filterKey.slice(1);
					queryParams.set('containers'+filterKeyCapitalized, filterValue);
				}

				htmx.ajax(
					'GET', '/overview/?' + queryParams.toString(),
					{
						select: '#containers-table',
						target: '#containers-table',
						indicator: '#loading-overlay',
						swap: 'outerHTML transition:true'
					},
				);
			},

			// Modal States
			isCreateContainerModalOpen: false,
			openCreateContainerModal() {
				this.resetPrimaryState();
				this.createContainerSelectedMarketplaceItemId = 0;

				this.isCreateContainerModalOpen = true;
			},
			closeCreateContainerModal() {
				this.isCreateContainerModalOpen = false;
				this.$dispatch('clear:component-state');
			},
			isUpdateContainerModalOpen: false,
			openUpdateContainerModal(accountId, containerId, profileId) {
				this.resetPrimaryState();

				this.container.accountId = accountId;
				this.container.id = containerId;
				this.container.profileId = profileId;
				this.isUpdateContainerModalOpen = true;
			},
			closeUpdateContainerModal() {
				this.isUpdateContainerModalOpen = false;
			},
			isShutdownContainerModalOpen: false,
			openShutdownContainerModal(accountId, containerId) {
				this.resetPrimaryState();

				this.container.accountId = accountId;
				this.container.id = containerId;
				this.isShutdownContainerModalOpen = true;
			},
			updateContainerStatus(newStatus) {
				return htmx.ajax(
					'PUT', '/api/v1/container/',
					{
						swap: 'none',
						values: {
							accountId: this.container.accountId,
							containerId: this.container.id,
							status: newStatus,
						}
					},
				);
			},
			shutdownContainer() {
				this.updateContainerStatus(false).then(() => {
					this.$dispatch('update:container');
				});
				this.isShutdownContainerModalOpen = false;
			},
			powerOnContainer(accountId, containerId) {
				this.resetPrimaryState();

				this.container.accountId = accountId;
				this.container.id = containerId;
				this.updateContainerStatus(true).then(() => {
					this.$dispatch('update:container');
				});
			},
			isRestartContainerModalOpen: false,
			openRestartContainerModal(accountId, containerId) {
				this.resetPrimaryState();

				this.container.accountId = accountId;
				this.container.id = containerId;
				this.isRestartContainerModalOpen = true;
			},
			restartContainer() {
				this.updateContainerStatus(false).then(() => {
					this.updateContainerStatus(true).then(() => {
						this.$dispatch('update:container');
					});
				});
				this.isRestartContainerModalOpen = false;
			},
			isDeleteContainerModalOpen: false,
			openDeleteContainerModal(accountId, containerId, hostname) {
				this.resetPrimaryState();

				this.container.accountId = accountId;
				this.container.id = containerId;
				this.container.hostname = hostname;
				this.isDeleteContainerModalOpen = true;
			},
			closeDeleteContainerModal() {
				this.isDeleteContainerModalOpen = false;
			},
			deleteContainer() {
				htmx.ajax(
					'DELETE',
					'/api/v1/container/' + this.container.accountId + '/' + this.container.id + '/',
					{swap: 'none'},
				).then(() => {
					this.$dispatch('delete:container');
				});
				this.closeDeleteContainerModal();
			},
		}))

		Alpine.data('resourceUsage', () => ({
			// Primary State
			cpuMemoryChart: {
				chartObject: null,
				seriesNames: ['cpu', 'memory'],
				seriesObjects: {},
			},
			networkIoChart: {
				chartObject: null,
				seriesNames: ['rx', 'tx'],
				seriesObjects: {},
			},
			networkPacketsChart: {
				chartObject: null,
				seriesNames: ['vrx', 'vtx', 'drx', 'dtx'],
				seriesObjects: {},
			},
			networkErrorsChart: {
				chartObject: null,
				seriesNames: ['rx', 'tx'],
				seriesObjects: {},
			},
			storageIoChart: {
				chartObject: null,
				seriesNames: ['read', 'write'],
				seriesObjects: {},
			},
			storageIopsChart: {
				chartObject: null,
				seriesNames: ['read', 'write'],
				seriesObjects: {},
			},
			storageSpaceChart: {
				chartObject: null,
				seriesNames: ['used'],
				seriesObjects: {},
			},
			storageInodesChart: {
				chartObject: null,
				seriesNames: ['used', 'free'],
				seriesObjects: {},
			},

			// Auxiliary State
			refreshIntervalSecs: 20,
			sysInfo: {
				serverHostname: '',
				cpuModel: '',
				memoryRamGibibytes: 0,
				publicIpAddress: '',
				privateIpAddress: '',
				uptimeRelative: '',
			},
			networkChartTabSelected: 'io',
			storageChartTabSelected: 'io',
			chartOptions: {
				layout: {
					textColor: 'white',
					background: { type: 'solid', color: 'transparent' },
					fontFamily: "Lato, sans-serif",
					attributionLogo: false,
				},
				width: 350,
				height: 250,
				autoSize: false,
				timeScale: { timeVisible: true, barSpacing: 20 },
				grid: { vertLines: { color: '#ffffff1a' }, horzLines: { color: '#ffffff1a' } },
			},
			chartSeriesOptions: {
				0: { lineColor: '#6628d9', topColor: '#6628d9', bottomColor: 'rgb(46 16 101 / 30%)' },
				1: { lineColor: '#b31d3f', topColor: '#b31d3f', bottomColor: 'rgb(72 9 26 / 30%)' },
				2: { lineColor: '#a16207', topColor: '#a16207', bottomColor: 'rgb(66 32 6 / 30%)' },
				3: { lineColor: '#1d4ed8', topColor: '#1d4ed8', bottomColor: 'rgb(23 37 84 / 30%)' },
			},
			async updateResourceUsageCharts() {
				const o11yOverview = await fetch("/api/v1/o11y/overview/", {
					method: "GET",
					headers: {
						Accept: "application/json",
						"Content-Type": "application/json",
					},
				})
					.then((apiResponse) => {
						if (!apiResponse.ok) {
							throw new Error('BadHttpResponseCode: ' + apiResponse.status);
						}

						return apiResponse.json();
					})
					.then((jsonResponse) => {
						return jsonResponse.body;
					})
					.catch((error) => {
						console.error(id+'ReadO11yOverviewError: ', error);
						return [];
					});

				const nowUnixTime = Date.now() / 1000;
				this.cpuMemoryChart.seriesObjects.cpu.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.cpuPercent },
				)
				this.cpuMemoryChart.seriesObjects.memory.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.memoryPercent },
				)
				let rxMebibytes = o11yOverview.resourceUsage.netInfoAggregated.recvBytes / 1024 / 1024;
				if (rxMebibytes < 1) {
					rxMebibytes = 0;
				}
				this.networkIoChart.seriesObjects.rx.update(
					{ time: nowUnixTime, value: rxMebibytes },
				)
				let txMebibytes = o11yOverview.resourceUsage.netInfoAggregated.sentBytes / 1024 / 1024;
				if (txMebibytes < 1) {
					txMebibytes = 0;
				}
				this.networkIoChart.seriesObjects.tx.update(
					{ time: nowUnixTime, value: txMebibytes },
				)
				this.networkPacketsChart.seriesObjects.vrx.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.netInfoAggregated.recvPackets },
				)
				this.networkPacketsChart.seriesObjects.vtx.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.netInfoAggregated.sentPackets },
				)
				this.networkPacketsChart.seriesObjects.drx.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.netInfoAggregated.recvDropPackets },
				)
				this.networkPacketsChart.seriesObjects.dtx.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.netInfoAggregated.sentDropPackets },
				)
				this.networkErrorsChart.seriesObjects.rx.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.netInfoAggregated.recvErrs },
				)
				this.networkErrorsChart.seriesObjects.tx.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.netInfoAggregated.sentErrs },
				)
				let readMebibytes = o11yOverview.resourceUsage.userDataStorageInfo.readBytes / 1024 / 1024;
				if (readMebibytes < 1) {
					readMebibytes = 0;
				}
				this.storageIoChart.seriesObjects.read.update(
					{ time: nowUnixTime, value: readMebibytes },
				)
				let writeMebibytes = o11yOverview.resourceUsage.userDataStorageInfo.writeBytes / 1024 / 1024;
				if (writeMebibytes < 1) {
					writeMebibytes = 0;
				}
				this.storageIoChart.seriesObjects.write.update(
					{ time: nowUnixTime, value: writeMebibytes },
				)
				this.storageIopsChart.seriesObjects.read.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.userDataStorageInfo.readOpsCount },
				)
				this.storageIopsChart.seriesObjects.write.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.userDataStorageInfo.writeOpsCount },
				)
				this.storageSpaceChart.seriesObjects.used.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.userDataStorageInfo.usedPercent },
				)
				this.storageInodesChart.seriesObjects.used.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.userDataStorageInfo.usedInodes },
				)
				this.storageInodesChart.seriesObjects.free.update(
					{ time: nowUnixTime, value: o11yOverview.resourceUsage.userDataStorageInfo.freeInodes },
				)

				if (this.sysInfo.serverHostname != "") {
					return;
				}
				this.sysInfo.serverHostname = o11yOverview.hostname;
				this.sysInfo.cpuModel = o11yOverview.specs.cpuModelName + " // " +
					o11yOverview.specs.cpuCoresCount + " @ " + o11yOverview.specs.cpuFrequency + " Ghz";
				const memoryRamGibibytes = o11yOverview.specs.memoryTotalBytes / 1024 / 1024 / 1024;
				this.sysInfo.memoryRamGibibytes = memoryRamGibibytes.toFixed(1) + " GiB";
				this.sysInfo.publicIpAddress = o11yOverview.publicIp;
				this.sysInfo.privateIpAddress = o11yOverview.privateIp;
				this.sysInfo.uptimeRelative = o11yOverview.uptimeRelative;
			},

			init() {
				const chartNames = [
					'cpuMemoryChart', 'networkIoChart', 'networkPacketsChart',
					'networkErrorsChart', 'storageIoChart', 'storageIopsChart',
					'storageSpaceChart', 'storageInodesChart',
				];
				for (const chartName of chartNames) {
					const domRef = this.$refs[chartName];
					if (domRef === undefined) {
						continue;
					}

					this[chartName].chartObject = LightweightCharts.createChart(domRef, this.chartOptions);
					for (const [seriesIndex, seriesName] of this[chartName].seriesNames.entries()) {
						let seriesOptions = this.chartSeriesOptions[seriesIndex];
						if (chartName === 'cpuMemoryChart' || chartName === 'storageSpaceChart') {
							seriesOptions = Object.assign({}, seriesOptions);
							seriesOptions.priceFormat = {
								type: 'percent',
								precision: 1,
							};
							seriesOptions.autoscaleInfoProvider = () => ({
								priceRange: {
									minValue: 0,
									maxValue: 80,
								},
							});
						}

						this[chartName].seriesObjects[seriesName] = this[chartName].chartObject.addAreaSeries(
							seriesOptions,
						);
					}
				}

				setInterval(() => {
					this.updateResourceUsageCharts();
				}, parseInt(this.refreshIntervalSecs) * 1000);
			}
		}))
	})
}

templ OverviewIndex(
	containersResponseDto dto.ReadContainersResponse,
	containerIdSummariesMap map[valueObject.ContainerId]componentContainer.ContainerSummary,
	createContainerDto CreateContainerModalDto,
) {
	@OverviewIndexLocalState(int(containersResponseDto.Pagination.PageNumber))
	<div class="flex flex-col">
		<div class="mb-6 flex flex-row justify-between">
			<div class="basis-[70%]">
				@componentStructural.PageTitle(
					"Overview",
					"Welcome! Take a quick peek at your platform's performance such as the containers, server resource usage and system information.",
					"ph-speedometer",
				)
			</div>
		</div>
		<div id="containers" class="card w-full" x-data="containers">
			<div class="-mt-15 float-right mb-5 w-fit">
				@componentStructural.IconButton(componentStructural.IconButtonSettings{
					Label:   "Create Container",
					Icon:    "ph-plus-square",
					OnClick: "openCreateContainerModal()",
				})
			</div>
			@ContainersTable(containersResponseDto, containerIdSummariesMap)
			@CreateContainerModal(createContainerDto)
			@UpdateContainerModal(createContainerDto.ContainerProfileSearchableItems)
			@componentStructural.ConfirmationModal(componentStructural.ConfirmationModalSettings{
				Title:            "Power Off Container",
				TitleIcon:        "ph-lightning-slash",
				Description:      "Are you sure you want to power off this container?<br />The container won't be accessible until powered back on.",
				ConfirmationType: componentStructural.ConfirmationTypeWarning,
				IsOpenState:      "isShutdownContainerModalOpen",
				ConfirmFunction:  "shutdownContainer()",
			})
			@componentStructural.ConfirmationModal(componentStructural.ConfirmationModalSettings{
				Title:            "Restart Container",
				TitleIcon:        "ph-arrows-clockwise",
				Description:      "Are you sure you want to restart this container?<br />The container will be stopped and started again.",
				ConfirmationType: componentStructural.ConfirmationTypeWarning,
				IsOpenState:      "isRestartContainerModalOpen",
				ConfirmFunction:  "restartContainer()",
			})
			@componentStructural.DeleteModal(
				"isDeleteContainerModalOpen", "closeDeleteContainerModal()", "deleteContainer()",
				"delete-container", "container.hostname", "container.id",
			)
		</div>
		<div x-data="resourceUsage">
			<div
				id="resource-usage-charts"
				class="card w-full"
			>
				@ResourceUsageCharts()
			</div>
			<div id="system-information" class="card w-full">
				@SystemInformation()
			</div>
		</div>
	</div>
}

templ ContainersTable(
	containersResponseDto dto.ReadContainersResponse,
	containerIdSummariesMap map[valueObject.ContainerId]componentContainer.ContainerSummary,
) {
	<!-- Containers Table -->
	<div
		id="containers-table"
		hx-get="/overview/"
		hx-trigger="submit from:form delay:500ms, update:container from:window delay:300ms, delete:container from:window delay:300ms"
		hx-select="#containers-table"
		hx-target="#containers-table"
		hx-swap="outerHTML transition:true"
		@update:containers-pagination="reloadContainersTable()"
		@update:containers-record-filters="reloadContainersTable()"
	>
		<div class="bg-ez-800 border-b border-neutral-500 border-opacity-90 p-2">
			@componentStructural.RecordFilters("containers", "containersFilters")
		</div>
		<table
			class="w-full table-fixed border-collapse rounded-md transition-all duration-300 ease-in-out"
		>
			<thead class="bg-ez-800 text-xs uppercase text-neutral-400">
				<tr class="border-b border-neutral-500 border-opacity-90 text-center">
					<th scope="col" class="w-[37.5%] overflow-x-hidden p-3 text-left">Container</th>
					<th scope="col" class="w-[10%] overflow-x-hidden py-3">CPU</th>
					<th scope="col" class="w-[10%] overflow-x-hidden py-3">RAM</th>
					<th scope="col" class="w-[7.5%] overflow-x-hidden py-3">Restarts</th>
					<th scope="col" class="w-[25%] overflow-x-hidden py-3">Port Bindings</th>
					<th scope="col" class="w-[10%] py-3"></th>
				</tr>
			</thead>
			<tbody>
				for _, containerEntity := range containersResponseDto.ContainersWithMetrics {
					<!-- Container Table Entry -->
					<tr class="odd:bg-ez-400 even:bg-ez-600 border-b border-neutral-500 border-opacity-30 text-center">
						@templ.JSONScript("containerEntity_"+containerEntity.Id.String(), containerEntity)
						<td class="w-[37.5%] overflow-x-hidden px-3 py-2 text-left">
							@componentContainer.ContainerTaggedSummary(
								containerIdSummariesMap[containerEntity.Id], "containersFilters",
							)
						</td>
						<td class="w-[10%] overflow-x-hidden px-3 py-2">
							<div class="flex items-center justify-center">
								@componentMisc.ProgressBar(componentMisc.ProgressBarSettings{
									Size:                 componentMisc.ProgressBarSizeSm,
									PercentProgressValue: float32(containerEntity.Metrics.CurrentCpuPercent),
									LabelCustomText:      containerEntity.Metrics.CurrentCpuPercentStr + "%",
									LabelBackgroundColor: "ez-800",
								})
							</div>
						</td>
						<td class="w-[10%] overflow-x-hidden px-3 py-2">
							<div class="flex items-center justify-center">
								@componentMisc.ProgressBar(componentMisc.ProgressBarSettings{
									Size:                 componentMisc.ProgressBarSizeSm,
									PercentProgressValue: float32(containerEntity.Metrics.MemoryPercent),
									LabelCustomText:      containerEntity.Metrics.MemoryPercentStr + "%",
									LabelBackgroundColor: "ez-800",
								})
							</div>
						</td>
						<td class="w-[7.5%] overflow-x-hidden px-3 py-2">
							{ strconv.FormatUint(containerEntity.RestartCount, 10) }
						</td>
						<td class="w-[25%] overflow-x-hidden px-3 py-2">
							if len(containerEntity.PortBindings) > 0 {
								@componentContainer.PortBindingsTable(containerEntity.PortBindings, true)
							} else {
								<div class="text-center text-neutral-400">---</div>
							}
						</td>
						<td class="w-[10%] px-3 py-2">
							<div class="flex flex-wrap items-center gap-1">
								@componentStructural.IconButton(componentStructural.IconButtonSettings{
									Id:                   "restart-container",
									Shape:                componentStructural.IconButtonShapeSquare,
									Icon:                 "ph-arrows-clockwise",
									BackgroundColor:      "ez-300",
									HoverBackgroundColor: "ez-200",
									OnClick:              "openRestartContainerModal('" + containerEntity.AccountId.String() + "','" + containerEntity.Id.String() + "')",
									TooltipText:          "Restart",
									TooltipColor:         "ez-300",
									TooltipPosition:      "top",
								})
								if containerEntity.Status {
									@componentStructural.IconButton(componentStructural.IconButtonSettings{
										Id:                   "toggle-container-status",
										Shape:                componentStructural.IconButtonShapeSquare,
										Icon:                 "ph-lightning-slash",
										BackgroundColor:      "yellow-900",
										HoverBackgroundColor: "yellow-700",
										OnClick:              "openShutdownContainerModal('" + containerEntity.AccountId.String() + "','" + containerEntity.Id.String() + "')",
										TooltipText:          "Power Off",
										TooltipColor:         "yellow-700",
										TooltipPosition:      "top",
									})
								} else {
									@componentStructural.IconButton(componentStructural.IconButtonSettings{
										Id:                   "toggle-container-status",
										Shape:                componentStructural.IconButtonShapeSquare,
										Icon:                 "ph-lightning",
										BackgroundColor:      "cyan-900",
										HoverBackgroundColor: "cyan-700",
										OnClick:              "powerOnContainer('" + containerEntity.AccountId.String() + "','" + containerEntity.Id.String() + "')",
										TooltipText:          "Power On",
										TooltipColor:         "cyan-700",
										TooltipPosition:      "top",
									})
								}
								@componentStructural.IconButton(componentStructural.IconButtonSettings{
									Id:                   "update-container",
									Shape:                componentStructural.IconButtonShapeSquare,
									Icon:                 "ph-gear",
									BackgroundColor:      "ez-300",
									HoverBackgroundColor: "ez-200",
									OnClick:              "openUpdateContainerModal('" + containerEntity.AccountId.String() + "','" + containerEntity.Id.String() + "','" + containerEntity.ProfileId.String() + "')",
									TooltipText:          "Update",
									TooltipColor:         "ez-300",
									TooltipPosition:      "bottom",
								})
								@componentStructural.IconButton(componentStructural.IconButtonSettings{
									Id:                   "delete-container",
									Shape:                componentStructural.IconButtonShapeSquare,
									Icon:                 "ph-trash",
									BackgroundColor:      "red-900",
									HoverBackgroundColor: "red-700",
									OnClick:              "openDeleteContainerModal('" + containerEntity.AccountId.String() + "','" + containerEntity.Id.String() + "','" + containerEntity.Hostname.String() + "')",
									TooltipText:          "Delete",
									TooltipColor:         "red-700",
									TooltipPosition:      "bottom",
								})
							</div>
						</td>
					</tr>
				}
				if len(containersResponseDto.ContainersWithMetrics) == 0 {
					<tr class="border-b border-neutral-500 border-opacity-30 bg-neutral-950 bg-opacity-20">
						<td class="px-3 py-2" colspan="12">No containers yet.</td>
					</tr>
				}
			</tbody>
		</table>
		<div class="bg-ez-800 border-t border-neutral-500 border-opacity-90 p-3">
			@componentStructural.Pagination(
				"containers",
				containersResponseDto.Pagination, "containersPagination.pageNumber",
				"containersPagination.itemsPerPage",
			)
		</div>
	</div>
}

templ CreateContainerForm(createDto CreateContainerModalDto) {
	<form
		hx-post="/api/v1/container/"
		hx-indicator="#loading-overlay"
		hx-swap="none"
		x-on:submit="closeCreateContainerModal(); $store.main.refreshScheduledTasksPopover()"
		enctype="multipart/form-data"
		class="space-y-4"
	>
		@componentForm.InputField(componentForm.InputFieldSettings{
			InputType: "text", InputName: "hostname", Label: "Hostname",
			ModelBindPath: "container.hostname", IsRequired: true,
		})
		<!-- ContainerSource & LaunchScript -->
		<div class="border-ez-200 flex flex-col gap-4 rounded-md border p-3">
			<div class="flex items-center space-x-3 text-sm">
				<div>Source: </div>
				for _, sourceOption := range []string{"Marketplace", "URL", "Existing Container", "Local Image", "Upload Image"} {
					@componentForm.RadioInput(componentForm.RadioInputDto{
						Label:         sourceOption,
						BindValue:     sourceOption,
						ModelBindPath: "createContainerSourceSelectedOption",
					})
				}
			</div>
			<div
				class="flex flex-row justify-center"
				x-show="createContainerSourceSelectedOption === 'Marketplace'"
			>
				<div>
					@componentStructural.VerticalTabHeader(
						[]componentStructural.TabHeaderItem{
							{Label: "App", Value: "App", Icon: "ph-browsers"},
							{Label: "Framework", Value: "Framework", Icon: "ph-cube"},
							{Label: "Stack", Value: "Stack", Icon: "ph-books"},
						},
						"createContainerSelectedMarketplaceType",
					)
				</div>
				<div class="border-3 border-ez-500 flex items-center rounded-md p-2">
					<div x-show="createContainerSelectedMarketplaceType === 'App'">
						@componentMisc.MultiItemCarousel(
							"appCarousel", createDto.AppMarketplaceCarouselItems, 5,
						)
					</div>
					<div x-show="createContainerSelectedMarketplaceType === 'Framework'">
						@componentMisc.MultiItemCarousel(
							"frameworkCarousel", createDto.FrameworkMarketplaceCarouselItems, 5,
						)
					</div>
					<div x-show="createContainerSelectedMarketplaceType === 'Stack'">
						@componentMisc.MultiItemCarousel(
							"stackCarousel", createDto.StackMarketplaceCarouselItems, 5,
						)
					</div>
				</div>
			</div>
			<div
				x-show="createContainerSourceSelectedOption === 'URL'"
				x-init="$watch('container.imageAddress', (newAddr, prevAddr) => autoPortBindingsRetriever(prevAddr, newAddr))"
			>
				@componentForm.RemoteSearchableSelectInput(
					"imageAddress", "Image Address", "container.imageAddress",
					"/api/v1/container/registry/image/", "name", "imageAddress",
					[]string{"pullCount", "starCount", "updatedAtRelative"},
				)
			</div>
			<div
				x-show="createContainerSourceSelectedOption === 'Existing Container'"
				x-init="$watch('container.existingContainerId', (newId, prevId) => syncExistingContainerPortBindings(prevId, newId))"
			>
				@componentForm.SearchableSelectInput(
					"existingContainerId", "Existing Container", "container.existingContainerId",
					createDto.ContainerSummarySearchableItems,
				)
			</div>
			<div x-show="createContainerSourceSelectedOption === 'Local Image'">
				@componentForm.SearchableSelectInput(
					"imageAddress", "Container Image", "container.imageAddress",
					createDto.ContainerImageSearchableItems,
				)
			</div>
			<div
				x-show="createContainerSourceSelectedOption === 'Upload Image'"
				class="flex flex-col gap-4"
			>
				@componentForm.Dropzone(
					"archiveImageFile", ".tar, .gzip, .zip, .xz or .br",
					".tar,.gzip,.zip,.xz,.br", false,
				)
				@componentForm.SwitchToggle(componentForm.SwitchToggleDto{
					Id:            "useImageExposedPorts",
					Label:         "Map the image's exposed ports (if any) as \"Port Bindings\".",
					ModelBindPath: "container.useImageExposedPorts",
				})
			</div>
			<div>
				<input
					type="hidden"
					id="launchScript"
					name="launchScript"
					x-model="btoa(container.launchScript)"
				/>
				@componentForm.TextArea(componentForm.TextAreaSettings{
					Label:         "Launch Script",
					ModelBindPath: "container.launchScript",
					IsCode:        true,
				})
				<p class="mt-1 px-1.5 text-[11px] text-neutral-50/50">
					Optional; one command per line. Executed only on initial container deployment, useful to install dependencies and configure the environment.
				</p>
			</div>
		</div>
		@componentForm.SearchableSelectInput(
			"profileId", "Profile", "container.profileId",
			createDto.ContainerProfileSearchableItems,
		)
		@componentStructural.CollapsibleSection("Advanced Settings", "ph-gear") {
			@componentForm.InputField(componentForm.InputFieldSettings{
				InputType: "text", InputName: "entrypoint", Label: "Entrypoint",
				ModelBindPath: "container.entrypoint",
			})
			<div class="flex flex-row items-center gap-6">
				<div class="basis-1/2">
					@componentForm.SelectInputWithLabelValuePair(
						componentForm.SelectInputWithLabelValuePairDto{
							Id:                    "accountId",
							Label:                 "Account",
							SelectedModelBindPath: "container.accountId",
							Options:               createDto.AccountSelectLabelValuePairs,
						},
					)
				</div>
				<div class="basis-1/2">
					@componentForm.SelectInput(componentForm.SelectInputDto{
						Id: "restartPolicy", Label: "Restart Policy",
						ModelBindPath: "container.restartPolicy",
						Options:       valueObject.ValidContainerRestartPolicies,
					})
				</div>
			</div>
			@componentForm.MultiColumnRepeatableFieldset(
				"envs", "Environment Variables", "", "container.envs", []componentForm.RepeatableField{
					{InputType: "text", Id: "key", Label: "Key"},
					{InputType: "text", Id: "value", Label: "Value"},
				},
			)
			@componentForm.MultiColumnRepeatableFieldset(
				"portBindings", "Port Bindings", "Configure which ports are exposed to the outside world. You may select just the 'Service Name' to use the standard ports. Be aware that once deployed, you cannot change the port arrangements.",
				"container.portBindings", []componentForm.RepeatableField{
					{
						InputType: "select",
						Id:        "serviceName",
						Label:     "Service Name",
						Options:   valueObject.ReadPortBindingsServiceNames(),
					},
					{InputType: "text", Id: "publicPort", Label: "Public Port"},
					{InputType: "text", Id: "containerPort", Label: "Container Port"},
					{
						InputType: "select",
						Id:        "protocol",
						Label:     "Protocol",
						Options:   valueObject.ValidNetworkProtocols,
					},
				},
			)
		}
		@componentStructural.IconButton(componentStructural.IconButtonSettings{
			Label: "Create",
			Icon:  "ph-check-fat",
		})
	</form>
}

templ MarketplaceCarouselItem(itemEntity entity.MarketplaceItem) {
	<!-- MultiItemCarouselItem JavaScript -->
	@templ.JSONScript("marketplaceItemEntity_"+itemEntity.Id.String(), itemEntity)
	<!-- MultiItemCarouselItem HTML -->
	<div
		@click={ "updateSelectedMarketplaceItem(" + itemEntity.Id.String() + ")" }
		class="bg-ez-500 hover:ring-infinite-500 hover:text-infinite-500 group relative flex cursor-pointer flex-col items-center justify-center rounded-md p-2 transition-all duration-300 hover:ring-1"
		:class={ "{'text-infinite-500 font-bold ring-1 ring-infinite-500': createContainerSelectedMarketplaceItemId === " + itemEntity.Id.String() + "}" }
	>
		<img
			src={ itemEntity.AvatarUrl.String() }
			alt={ itemEntity.Name.String() + " Avatar" }
			class="max-w-18 m-auto rounded-md transition-all duration-300 group-hover:sepia"
			:class={ "{'sepia': createContainerSelectedMarketplaceItemId === " + itemEntity.Id.String() + "}" }
		/>
		<div class="text-wrap mt-1 break-words text-center text-xs">
			{ itemEntity.Name.String() }
		</div>
		<div class="bg-ez-600 min-w-100 absolute left-1/2 top-full z-10 mt-1 hidden -translate-x-1/2 transform rounded-md p-3 text-xs text-neutral-50 shadow-lg transition-all duration-500 group-hover:block group-hover:translate-y-0.5">
			<div class="flex flex-row items-center gap-3">
				<div class="basis-3/4 font-normal">
					{ itemEntity.Description.String() }
				</div>
				<div class="basis-1/4 space-y-1.5">
					<p class="text-xs font-bold">Requirements</p>
					if itemEntity.MinimumCpuMillicores != nil {
						@componentMisc.TinyTag(
							"ph-speedometer", "", itemEntity.MinimumCpuMillicores.ToCoresString(), "infinite-500",
						)
					}
					if itemEntity.MinimumMemoryBytes != nil {
						@componentMisc.TinyTag(
							"ph-memory", "", itemEntity.MinimumMemoryBytes.StringWithSuffix(), "infinite-500",
						)
					}
					if itemEntity.EstimatedSizeBytes != nil {
						@componentMisc.TinyTag(
							"ph-hard-drives", "", itemEntity.EstimatedSizeBytes.StringWithSuffix(), "infinite-500",
						)
					}
				</div>
			</div>
		</div>
	</div>
}

templ CreateContainerModal(createDto CreateContainerModalDto) {
	@componentStructural.RegularModal(
		"Create Container", "isCreateContainerModalOpen", "closeCreateContainerModal()", "",
	) {
		@CreateContainerForm(createDto)
	}
}

templ UpdateContainerForm(
	containerProfileSearchableItems []componentForm.SearchableSelectItem,
) {
	<form
		hx-put="/api/v1/container/"
		hx-indicator="#loading-overlay"
		hx-swap="none"
		class="space-y-4"
		x-on:submit="closeUpdateContainerModal()"
	>
		<input type="hidden" name="containerId" x-bind:value="container.id"/>
		<input type="hidden" name="accountId" x-bind:value="container.accountId"/>
		@componentForm.SearchableSelectInput(
			"profileId", "Profile", "container.profileId",
			containerProfileSearchableItems,
		)
		@componentStructural.IconButton(componentStructural.IconButtonSettings{
			Label: "Update",
			Icon:  "ph-check-fat",
		})
	</form>
}

templ UpdateContainerModal(
	containerProfileSearchableItems []componentForm.SearchableSelectItem,
) {
	@componentStructural.RegularModal(
		"Update Container", "isUpdateContainerModalOpen",
		"closeUpdateContainerModal()", "container.id",
	) {
		@UpdateContainerForm(containerProfileSearchableItems)
	}
}

templ ChartLegend(firstSeriesName, secondSeriesName, thirdSeriesName, fourthSeriesName string) {
	<div class="flex cursor-not-allowed flex-row items-center gap-2 text-[11px] text-neutral-300">
		<div class="flex flex-row items-center gap-1">
			<span class="h-4 w-4 rounded-full border-2 border-purple-700 bg-purple-950"></span>
			{ firstSeriesName }
		</div>
		if secondSeriesName != "" {
			<div class="flex flex-row items-center gap-1">
				<span class="h-4 w-4 rounded-full border-2 border-pink-700 bg-pink-950"></span>
				{ secondSeriesName }
			</div>
		}
		if thirdSeriesName != "" {
			<div class="flex flex-row items-center gap-1">
				<span class="h-4 w-4 rounded-full border-2 border-yellow-700 bg-yellow-950"></span>
				{ thirdSeriesName }
			</div>
		}
		if fourthSeriesName != "" {
			<div class="flex flex-row items-center gap-1">
				<span class="h-4 w-4 rounded-full border-2 border-blue-700 bg-blue-950"></span>
				{ fourthSeriesName }
			</div>
		}
	</div>
}

templ ResourceUsageCharts() {
	<div class="bg-ez-800 mt-4 rounded-md p-4" x-init.debounce.1s="$nextTick(() => {updateResourceUsageCharts()})">
		<div class="flex flex-row items-center justify-between">
			@componentStructural.PageSubHeading("Resource Usage", "", "ph-chart-line")
			<p class="text-right text-[9px] italic text-neutral-500">
				charts by <a href="https://www.tradingview.com/" class="hover:underline">TradingView Lightweight Charts™</a>
			</p>
		</div>
		<div class="grid grid-cols-3 items-center justify-center gap-6">
			<div class="flex flex-col items-center justify-center gap-4">
				@ChartLegend("CPU (%)", "Memory (%)", "", "")
				<div x-ref="cpuMemoryChart" class="flex justify-center"></div>
			</div>
			<div>
				@componentStructural.HorizontalTabHeader(
					[]componentStructural.TabHeaderItem{
						{Label: "Network IO", Value: "io"},
						{Label: "Packets", Value: "packets"},
						{Label: "Errors", Value: "errors"},
					},
					"networkChartTabSelected",
				)
				<div class="rounded-lb-md rounded-r-md bg-neutral-100 bg-opacity-[4%] px-2 py-4">
					<div
						x-show="networkChartTabSelected === 'io'"
						class="flex flex-col items-center justify-center gap-4"
					>
						@ChartLegend("Received (MiB/s)", "Transmitted (MiB/s)", "", "")
						<div x-ref="networkIoChart"></div>
					</div>
					<div
						x-show="networkChartTabSelected === 'packets'"
						class="flex flex-col items-center justify-center gap-4"
					>
						@ChartLegend(
							"Successfully Received", "Successfully Transmitted",
							"Dropped Received", "Dropped Transmitted",
						)
						<div x-ref="networkPacketsChart"></div>
					</div>
					<div
						x-show="networkChartTabSelected === 'errors'"
						class="flex flex-col items-center justify-center gap-4"
					>
						@ChartLegend("Received", "Transmitted", "", "")
						<div x-ref="networkErrorsChart"></div>
					</div>
				</div>
			</div>
			<div>
				@componentStructural.HorizontalTabHeader(
					[]componentStructural.TabHeaderItem{
						{Label: "Storage IO", Value: "io"},
						{Label: "IOPS", Value: "iops"},
						{Label: "Space", Value: "space"},
						{Label: "Inodes", Value: "inodes"},
					},
					"storageChartTabSelected",
				)
				<div class="rounded-lb-md rounded-r-md bg-neutral-100 bg-opacity-[4%] px-2 py-4">
					<div
						x-show="storageChartTabSelected === 'io'"
						class="flex flex-col items-center justify-center gap-4"
					>
						@ChartLegend("Read (MiB/s)", "Write (MiB/s)", "", "")
						<div x-ref="storageIoChart"></div>
					</div>
					<div
						x-show="storageChartTabSelected === 'iops'"
						class="flex flex-col items-center justify-center gap-4"
					>
						@ChartLegend("Read (Op/s)", "Write (Op/s)", "", "")
						<div x-ref="storageIopsChart"></div>
					</div>
					<div
						x-show="storageChartTabSelected === 'space'"
						class="flex flex-col items-center justify-center gap-4"
					>
						@ChartLegend("Used Space (%)", "", "", "")
						<div x-ref="storageSpaceChart"></div>
					</div>
					<div
						x-show="storageChartTabSelected === 'inodes'"
						class="flex flex-col items-center justify-center gap-4"
					>
						@ChartLegend("Used Inodes", "Free Inodes", "", "")
						<div x-ref="storageInodesChart"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
}

templ SystemInformation() {
	<div class="bg-ez-800 mt-4 grid grid-cols-3 gap-4 rounded-md p-4">
		@componentForm.InputField(componentForm.InputFieldSettings{
			InputType:     "text",
			InputName:     "serverHostname",
			Label:         "Server Hostname",
			ModelBindPath: "sysInfo.serverHostname",
			IsReadOnly:    true,
		})
		@componentForm.InputField(componentForm.InputFieldSettings{
			InputType:     "text",
			InputName:     "cpuModel",
			Label:         "CPU",
			ModelBindPath: "sysInfo.cpuModel",
			IsReadOnly:    true,
		})
		@componentForm.InputField(componentForm.InputFieldSettings{
			InputType:     "text",
			InputName:     "memoryRamGibibytes",
			Label:         "Memory (RAM)",
			ModelBindPath: "sysInfo.memoryRamGibibytes",
			IsReadOnly:    true,
		})
		@componentForm.InputField(componentForm.InputFieldSettings{
			InputType:     "text",
			InputName:     "publicIpAddress",
			Label:         "Public IP Address",
			ModelBindPath: "sysInfo.publicIpAddress",
			IsReadOnly:    true,
		})
		@componentForm.InputField(componentForm.InputFieldSettings{
			InputType:     "text",
			InputName:     "privateIpAddress",
			Label:         "Private IP Address",
			ModelBindPath: "sysInfo.privateIpAddress",
			IsReadOnly:    true,
		})
		@componentForm.InputField(componentForm.InputFieldSettings{
			InputType:     "text",
			InputName:     "uptimeRelativeStr",
			Label:         "Server Uptime",
			ModelBindPath: "sysInfo.uptimeRelative",
			IsReadOnly:    true,
		})
	</div>
}
